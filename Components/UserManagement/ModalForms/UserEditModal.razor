@using BlazorGoldenZebra.Data
@using BlazorGoldenZebra.Models.ViewModels
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using static BlazorGoldenZebra.Components.UserManagement.UserList

@inject UserManager<ApplicationUser> _userManager 
@inject IDbContextFactory<GoldenZebraSecurityContext> DbFactory
@* @inject NavigationManager NavigationManager  *@

@* @inject GoldenZebraSecurityContext context *@

@* @rendermode InteractiveServer *@

@attribute [Authorize(Roles = "admin")]

<div class="row">
    <div class="col-md-12">
        <EditForm method="post" Model="User" OnValidSubmit="UpdateUser" FormName="edit" Enhance>
            <DataAnnotationsValidator />
            <ValidationSummary role="alert" />
            <input type="hidden" name="User.Id" value="@User.Id" />
            <div class="mb-6">
                <label for="userName" class="form-label">Login:</label>
                <InputText id="userName" @bind-Value="User.UserName" class="form-control" />
                <ValidationMessage For="() => User.UserName" class="text-danger" />
            </div>
            <div class="mb-6">
                <label for="isLocked" class="form-label">Заблокирован:</label>
                <InputCheckbox id="isLocked" @bind-Value="User.IsLocked" />
                <ValidationMessage For="() => User.IsLocked" class="text-danger" />
            </div>
            <div class="mb-6">
                @foreach (var userRole in User.UserRoles)
                {
                    <label>
                        <InputCheckbox @bind-Value="userRole.IsInRole" />
                        @userRole.RoleName
                    </label>
                }
            </div>
            <hr />
            <button type="submit" class="btn btn-warning"><i class="bi bi-pencil"></i> Сохранить</button>
        </EditForm>
    </div>
</div>

@code {
    //[SupplyParameterFromQuery]
    //[CascadingParameter]
    [Parameter]
    public string UserId { get; set; }

    [Parameter]
    public Func<Task> AfterSave { get; set; }

    [SupplyParameterFromForm]
    private UserEditModel? User { get; set; } = new UserEditModel();

    private GoldenZebraSecurityContext context = default!;

    private ApplicationUser AppUser;

    // protected override void OnInitialized()
    // {
    //     context ??= DbFactory.CreateDbContext();
    // }

    protected override void OnInitialized()
    {
        context ??= DbFactory.CreateDbContext();
        var user = context.AspNetUsers.Include(u => u.Roles).FirstOrDefault(m => m.Id == UserId);
        var roles = context.AspNetRoles.ToList();

        AppUser = _userManager.Users.Single(u => u.UserName.Equals(user.UserName));

        User.Id = UserId;
        User.UserName = user.UserName;
        User.IsLocked = user.LockoutEnd.HasValue;

        // User.UserRoles
        foreach (var role in roles)
        {
            User.UserRoles.Add(new UserRoleModel
            {
                RoleName = role.Name,
                IsInRole = user.Roles.Any(x => x.Name.Equals(role.Name))
            });
        }

        context.Dispose();

        // if (User is null)
        // {
        //     NavigationManager.NavigateTo("notfound");
        // }
    }

    // public async ValueTask DisposeAsync() => await context.DisposeAsync();

    // To protect from overposting attacks, enable the specific properties you want to bind to.
    // For more information, see https://learn.microsoft.com/aspnet/core/blazor/forms/#mitigate-overposting-attacks.
    private async Task UpdateUser()
    {
        using var context = DbFactory.CreateDbContext();
        var user = context.AspNetUsers.Include(u => u.Roles).FirstOrDefault(m => m.Id == UserId);
        var roles = context.AspNetRoles.ToList();
        //context.Attach(Movie!).State = EntityState.Modified;

        user.UserName = User.UserName;
        user.LockoutEnd = User.IsLocked ? DateTimeOffset.MaxValue : default(DateTimeOffset?);

        var goodRoles = User.UserRoles
            .Where(x => x.IsInRole)
            .Select(x => x.RoleName)
            .ToList();
        var badRoles = User.UserRoles
            .Where(x => !x.IsInRole)
            .Select(x => x.RoleName)
            .ToList();

        // await _userManager.RemoveFromRolesAsync(AppUser, badRoles);

        // await _userManager.AddToRolesAsync(AppUser, goodRoles);
        
        foreach (var role in user.Roles.Where(r => badRoles.Any(b => b.Equals(r.Name))))
        {
            //user.Roles.Remove(role);
            await _userManager.RemoveFromRoleAsync(AppUser, role.Name);
        }

        foreach (var role in roles.Where(r => goodRoles.Any(b => b.Equals(r.Name))))
        {
            //user.Roles.Add(role);
            await _userManager.AddToRoleAsync(AppUser, role.Name);
        }


        try
        {
            await context.SaveChangesAsync();
            // await modal.HideAsync();
            if(AfterSave != null)
            {
                await AfterSave();
            }
        }
        catch
        {
            throw;   
        }
        /*catch (DbUpdateConcurrencyException)
        {
            if (!MovieExists(Movie!.Id))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }*/

        //NavigationManager.NavigateTo("/movies");
    }
}
